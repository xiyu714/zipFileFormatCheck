<!DOCTYPE html>
<!--
  包含两部分：
    1.从url中获取验证文本
    2.用户上传文件（zip压缩）
      jszip.js解压
 -->
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="jszip.js"></script>
    <title>fileCheck</title>
  </head>
  <body>
    <input type="file" accept="application/zip" id="file-input">
    <div>
      <p id="result"></p>
    </div>
  </body>
  <script type="text/javascript">
    var result = document.getElementById("result")
    //获取check对象
    var params = new URLSearchParams(window.location.toString().split("?")[1])
    var checkString = params.get("check");
    //检测是否有检测脚本
    var checkObject = JSON.parse(checkString)
    //主体部分
    fileOfInput = document.getElementById("file-input")
    fileOfInput.addEventListener("change", function(event) {
      zipfile = fileOfInput.files[0]  //方便调试
      //测试压缩文件名
      var name = zipfile.name.split(".")[0]
      if(!checkName(name, checkObject.zipName)) {
        result.textContent = "压缩文件名不符合要求"
        return
      }
      //接下来验证压缩文件中类容是否正确
      var jszip = new JSZip();
      /*
        jszip可以使用file()和folde()创建和获取文件以及文件夹
      */
      //验证一级目录
      jszip.loadAsync(zipfile).then(function(zip) {
        ozip = zip
        /*
          由于JSzip未提供层级化的遍历结构
          所以会比较麻烦
        */
        nameArray = []
        ozip.forEach(function(name){nameArray.push(name)})
        //测试规则
        if(match(checkObject.rules, nameArray) == true) {
          result.textContent = "格式正确";
        } else {
          result.textContent = "格式错误";
        }
      })
    })

    function matchOne(refileRule, files) { //refileRule为refile规则，files是一个filename数组
      var r = /\${(\d*)(,*)\s*(\d*)}$/;
      var rresult = r.exec(refileRule)
      if(rresult == null) { //无限制次数匹配
        let regex = RegExp(reString);
        files.forEach(function(filename, index) {
          if(regex.test(filename)) {
            files.splice(index, 1); //从中删除一个元素
          }
        })
      } else {
        let one = rresult[1];
        let comma = rresult[2];
        let two = rresult[3];
        let reString = refileRule.replace(rresult[0]);
        let regex = RegExp(reString);
        if(comma == "") { //假设one不为""   //固定次数模式
          let num = 0;
          files.forEach(function(filename, index) {
            if(regex.test(filename)) {
              num += 1;
              files.splice(index, 1); //从中删除一个元素
            }
          })
          if(num == parseInt(one)) {
            return true;
          } else {
            return false;
          }
        } else if (two == "") { //one次及以上
          let num = 0;
          files.forEach(function(filename, index) {
            if(regex.test(filename)) {
              num += 1;
              files.splice(index, 1); //从中删除一个元素
            }
          })
          if(num >= parseInt(one)) {
            return true;
          } else {
            return false;
          }
        } else {  //one到two次
          let num = 0;
          files.forEach(function(filename, index) {
            if(regex.test(filename)) {
              num += 1;
              files.splice(index, 1); //从中删除一个元素
            }
          })
          if(num >= parseInt(one) && num <= parseInt(two)) {
            return true;
          } else {
            return false;
          }
        }
      }
    }
    function match(refileRules, files) { //refileRules是一个refile规则数组，files是一个filename数组
      var filesBuffer = files.slice();  //在这个缓冲区中的filename都要被相应的规则匹配掉才能返回真
      if(refileRules == undefined) {
        return true;
      }
      for(let refileRule of refileRules) {
        if(matchOne(refileRule, filesBuffer) == false) {
          return false;
        }
      }
      if(filesBuffer.length == 0) {
        return true
      } else {
        return false
      }
    }
    function checkName(name, reString) {
      if(reString) {
        regex = new RegExp(reString)
        return regex.test(name)
      } else {
        return true
      }
      return true;
    }
  </script>
</html>
